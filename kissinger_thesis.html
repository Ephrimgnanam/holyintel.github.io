<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kissinger Thesis — Reader</title>
    <meta name="description" content="Reader for the improved Kissinger thesis Markdown, rendered client-side with beautiful typography and dark mode." />
    <meta name="theme-color" content="#0ea5e9" />

    <!-- Open Graph / Twitter (inherits main site assets) -->
    <meta property="og:title" content="Kissinger Thesis — Reader" />
    <meta property="og:description" content="Client-rendered Markdown with elegant typography and dark mode." />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://dicklesworthstone.github.io/kissinger_undergraduate_thesis/assets/og.jpg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1593" />
    <meta property="og:image:alt" content="Portrait of Henry A. Kissinger" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Early theme init to avoid FOUC -->
    <script>
      (function () {
        try {
          const t = localStorage.getItem('theme');
          const d = t ? t === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (d) document.documentElement.classList.add('dark');
        } catch (_) {}
      })();
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Literata:wght@400;500;600;700&family=Newsreader:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#0ea5e9" />
    <link rel="manifest" href="site.webmanifest" />

    <!-- Tailwind CSS (CDN) + Typography plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
              serif: ['Literata', 'ui-serif', 'Georgia', 'serif'],
            },
            colors: {
              brand: { 50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a' },
            },
          }
        }
      }
    </script>

    <!-- Highlight.js (light/dark themes) -->
    <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" crossorigin="anonymous" />
    <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" crossorigin="anonymous" disabled />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" crossorigin="anonymous"></script>

    <!-- Markdown renderer (with footnotes) + sanitizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js" integrity="sha256-gZ3xe0BdCJplNiHWTKrm6AGZydPy34jJKZqFIf+7hIw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it-footnote/3.0.3/markdown-it-footnote.min.js" integrity="sha256-6AlG8g/YBkXo4Ga0dVmyMuPEoODo0kb1adqzkoEAl5A=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" integrity="sha256-wIRQlqfEpnQfNirFBslMHH0n3GA7zBv2Slh/dvLb46E=" crossorigin="anonymous"></script>

    <style>
      .backdrop-grid { background-size: 24px 24px; background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.06) 1px, transparent 0) }
      .dark .backdrop-grid { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0) }
      .reveal { opacity: 0; transform: translateY(8px); transition: opacity .6s ease, transform .6s ease }
      .reveal-visible { opacity: 1; transform: none }
      @media (prefers-reduced-motion: reduce) { .reveal { transition: none; transform: none } }
      /* Reader controls via CSS variables */
      #reader { font-size: var(--reader-font, 1rem); max-width: min(100%, var(--reader-width, 75ch)); margin-inline: auto; font-family: var(--reader-ff, "Literata", ui-serif, Georgia, serif); word-break: normal; overflow-wrap: normal; hyphens: manual }
      /* TOC active state */
      .toc a { display:block; padding:2px 6px; border-left:2px solid transparent; border-radius:4px }
      .toc a[aria-current="true"] { color: rgb(59 130 246); border-left-color: rgb(59 130 246); font-weight:600 }
      /* Footnotes styling */
      .footnotes { color: inherit; }
      .footnotes hr { border: none; border-top: 1px solid rgba(148,163,184,.25); margin: 1.5rem 0; }
      .dark .footnotes hr { border-top-color: rgba(148,163,184,.35); }
      .footnotes ol { font-size: .95em; padding-left: 1.25rem; }
      .footnotes li { margin-top: .5rem; }
      .footnote-backref { text-decoration: none; margin-left: .25rem; opacity:.75 }
      /* Auto-hide header */
      #siteHeader { transition: transform .3s ease; will-change: transform }
      #siteHeader.header-hidden { transform: translateY(-100%) }
      /* Toggle active state */
      .btn-toggle[aria-pressed="true"] { background: rgba(0,0,0,.08) }
      .dark .btn-toggle[aria-pressed="true"] { background: rgba(255,255,255,.12) }
    </style>
  </head>
  <body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 font-sans selection:bg-brand-400 selection:text-white">
    <a href="#content" class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-50 focus:rounded-lg focus:bg-brand-600 focus:px-3 focus:py-2 focus:text-white">Skip to content</a>

    <!-- Decorative background -->
    <div class="pointer-events-none fixed inset-0 overflow-hidden">
      <div class="absolute -top-32 right-[-10%] h-72 w-72 rounded-full bg-brand-600/15 dark:bg-brand-600/25 blur-3xl backdrop-glow"></div>
      <div class="absolute top-1/2 -left-24 h-80 w-80 -translate-y-1/2 rounded-full bg-sky-500/10 dark:bg-sky-500/20 blur-3xl backdrop-glow"></div>
      <div class="absolute inset-0 backdrop-grid"></div>
    </div>

    <!-- Header -->
    <header id="siteHeader" class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-slate-950/60 border-b border-black/5 dark:border-white/10">
      <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="index.html" class="h-10 w-10 grid place-items-center rounded-lg bg-brand-600/15 ring-1 ring-brand-500/25 shadow-glow" title="Back to index">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-brand-600 dark:text-brand-200"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"/></svg>
          </a>
          <div>
            <h1 class="text-base md:text-lg font-semibold tracking-tight">Kissinger Thesis — Reader</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400">Markdown rendered with typography & dark mode</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="relative">
            <button id="themeToggle" class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/10 hover:bg-black/5 dark:hover:bg-white/10 transition" aria-label="Toggle theme">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden dark:inline h-5 w-5 text-amber-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"/></svg>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline dark:hidden h-5 w-5 text-slate-700 dark:text-slate-200"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/></svg>
              <span class="hidden sm:inline">Theme</span>
            </button>
          </div>
          <a class="inline-flex items-center gap-2 rounded-lg bg-black/5 dark:bg-white/5 px-3 py-2 text-sm text-slate-700 dark:text-slate-200 ring-1 ring-black/10 dark:ring-white/10 hover:bg-black/10 dark:hover:bg-white/10 transition" href="docs/kissinger_thesis.md" target="_blank" rel="noopener noreferrer" title="Open Markdown source">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg>
            <span class="hidden sm:inline">Markdown</span>
          </a>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main id="content" class="relative mx-auto max-w-6xl px-6 pb-20">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-8">
        <article id="reader" class="prose prose-slate prose-headings:scroll-mt-24 dark:prose-invert prose-img:rounded-xl prose-pre:bg-slate-900/90 dark:prose-pre:bg-slate-900 prose-pre:ring-1 prose-pre:ring-black/10 dark:prose-pre:ring-white/10 prose-a:text-brand-700 dark:prose-a:text-brand-300">
          <div id="loading" class="flex items-center gap-3 text-slate-600 dark:text-slate-300 py-12">
            <svg class="animate-spin h-5 w-5 text-brand-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            <span>Loading thesis…</span>
          </div>
        </article>
        <aside class="hidden lg:block sticky top-20 self-start reveal">
          <div class="rounded-xl border border-black/5 dark:border-white/10 bg-white/70 dark:bg-white/5 p-4 ring-1 ring-inset ring-black/5 dark:ring-white/10">
            <h2 class="text-sm font-semibold text-slate-700 dark:text-slate-300">On this page</h2>
            <nav id="toc" class="mt-3 text-sm text-slate-600 dark:text-slate-300 space-y-2 toc"></nav>
          </div>
        </aside>
      </div>
    </main>

    <script>
      // Theme toggle + switch HLJS theme
      const syncHljsTheme = () => {
        const dark = document.documentElement.classList.contains('dark');
        const lightLink = document.getElementById('hljs-light');
        const darkLink = document.getElementById('hljs-dark');
        if (lightLink && darkLink) {
          lightLink.disabled = dark;
          darkLink.disabled = !dark;
        }
      };
      document.getElementById('themeToggle')?.addEventListener('click', () => {
        const root = document.documentElement;
        const isDark = root.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch (_) {}
        syncHljsTheme();
      });
      syncHljsTheme();

      // Configure Markdown-It with footnotes and highlight
      const mdIt = window.markdownit({
        html: false,
        linkify: true,
        typographer: true,
        breaks: false,
        highlight: (code, lang) => {
          try {
            if (lang && hljs.getLanguage(lang)) {
              return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
          } catch { return code; }
        }
      }).use(window.markdownitFootnote);

      // Load and render Markdown
      (async function renderMD() {
        const targets = [
          'docs/kissinger_thesis.md',
          'https://raw.githubusercontent.com/Dicklesworthstone/kissinger_undergraduate_thesis/main/docs/kissinger_thesis.md'
        ];
        let mdSrc = null;
        for (const url of targets) {
          try {
            const res = await fetch(url, { cache: 'no-cache' });
            if (res.ok) { mdSrc = await res.text(); break; }
          } catch (e) { /* try next */ }
        }
        const reader = document.getElementById('reader');
        const loading = document.getElementById('loading');
        if (!mdSrc) {
          if (loading) loading.textContent = 'Failed to load Markdown.';
          return;
        }

        // Render + sanitize
        const html = DOMPurify.sanitize(mdIt.render(mdSrc));
        reader.innerHTML = html;

        // Set document title from first heading
        const h1 = reader.querySelector('h1');
        if (h1) document.title = h1.textContent + ' — Reader';

        // Build TOC from h2/h3 (and ensure IDs)
        const toc = document.getElementById('toc');
        if (toc) {
          const links = [];
          const headings = reader.querySelectorAll('h2, h3');
          const frag = document.createDocumentFragment();
          headings.forEach(h => {
            const id = h.id || h.textContent.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
            h.id = id;
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = h.textContent;
            a.style.paddingLeft = h.tagName === 'H3' ? '1rem' : '0';
            frag.appendChild(a);
            links.push({ id, el: a, h });
          });
          toc.innerHTML = '';
          toc.appendChild(frag);
          // Scrollspy
          if ('IntersectionObserver' in window) {
            const spy = new IntersectionObserver((entries) => {
              let best = null;
              for (const e of entries) {
                if (e.isIntersecting) {
                  if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
                }
              }
              if (best) {
                const id = best.target.id;
                links.forEach(l => l.el.setAttribute('aria-current', l.id === id ? 'true' : 'false'));
              }
            }, { rootMargin: '-20% 0px -60% 0px', threshold: [0, 0.25, 0.5, 0.75, 1] });
            links.forEach(l => spy.observe(l.h));
          }
        }

        // Highlight code blocks after injection
        document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
      })();

      // Reader controls: font family, size, width, background texture
      (function readerControls(){
        const root = document.getElementById('reader');
        const headerEl = document.getElementById('siteHeader');
        let scrollHandler = null;
        const enableAutoHide = () => {
          if (scrollHandler) return;
          let lastY = window.scrollY;
          scrollHandler = () => {
            const y = window.scrollY;
            if (y <= 64) {
              headerEl?.classList.remove('header-hidden');
            } else if (y > lastY + 5) {
              headerEl?.classList.add('header-hidden');
            } else if (y < lastY - 5) {
              headerEl?.classList.remove('header-hidden');
            }
            lastY = y;
          };
          window.addEventListener('scroll', scrollHandler, { passive: true });
        };
        const disableAutoHide = () => {
          if (scrollHandler) {
            window.removeEventListener('scroll', scrollHandler);
            scrollHandler = null;
          }
          headerEl?.classList.remove('header-hidden');
        };
        const getNum = (v, def) => {
          const n = parseFloat(v); return Number.isFinite(n) ? n : def;
        };
        const defaults = { font:'1', width:'75', ff:'serif', bg:'on', ah:'off' };
        const resetAll = () => {
          try {
            localStorage.setItem('reader:font', defaults.font);
            localStorage.setItem('reader:width', defaults.width);
            localStorage.setItem('reader:ff', defaults.ff);
            localStorage.setItem('reader:bg', defaults.bg);
            localStorage.setItem('reader:autohide', defaults.ah);
          } catch(_) {}
          apply();
        };
        const apply = () => {
          const f = localStorage.getItem('reader:font') || '1';
          const w = localStorage.getItem('reader:width') || '75';
          const ff = localStorage.getItem('reader:ff') || 'serif';
          const bg = localStorage.getItem('reader:bg') || 'on';
          const ah = localStorage.getItem('reader:autohide') || 'off';
          root.style.setProperty('--reader-font', getNum(f,1) + 'rem');
          root.style.setProperty('--reader-width', getNum(w,75) + 'ch');
          const map = {
            'sans': 'Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji", sans-serif',
            'serif': 'Literata, ui-serif, Georgia, Cambria, "Times New Roman", Times, serif',
            'news': 'Newsreader, ui-serif, Georgia, Cambria, "Times New Roman", Times, serif'
          };
          root.style.setProperty('--reader-ff', map[ff] || map['serif']);
          // Apply background texture/glow visibility
          const grid = document.querySelector('.backdrop-grid');
          if (grid) grid.classList.toggle('hidden', bg === 'off');
          document.querySelectorAll('.backdrop-glow').forEach(el => el.classList.toggle('hidden', bg === 'off'));
          // Auto-hide header
          if (ah === 'on') enableAutoHide(); else disableAutoHide();
        };
        apply();
        // Build a minimal controls popover near the Theme button
        const wrap = document.createElement('div');
        wrap.id = 'readerControls';
        wrap.className = 'absolute z-50 right-0 top-full mt-2 w-64 rounded-lg border border-black/5 dark:border-white/10 bg-white/90 dark:bg-slate-900/90 backdrop-blur p-3 ring-1 ring-inset ring-black/5 dark:ring-white/10 shadow-lg hidden';
        wrap.innerHTML = `
          <div class="text-xs font-semibold text-slate-600 dark:text-slate-300 mb-2">Reader settings</div>
          <div class="flex items-center justify-between gap-2 mb-2">
            <span class="text-xs text-slate-600 dark:text-slate-300">Font family</span>
            <div class="inline-flex overflow-hidden rounded-md border border-black/10 dark:border-white/10">
              <button data-ff="sans" class="btn-toggle px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">Sans</button>
              <button data-ff="serif" class="btn-toggle px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">Serif</button>
              <button data-ff="news" class="btn-toggle px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">News</button>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2 mb-2">
            <span class="text-xs text-slate-600 dark:text-slate-300">Font size</span>
            <div class="inline-flex overflow-hidden rounded-md border border-black/10 dark:border-white/10">
              <button id="fontDec" class="px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">A-</button>
              <button id="fontInc" class="px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">A+</button>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2 mb-2">
            <span class="text-xs text-slate-600 dark:text-slate-300">Background texture</span>
            <div class="inline-flex overflow-hidden rounded-md border border-black/10 dark:border-white/10">
              <button data-bg="on" class="btn-toggle w-14 px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">On</button>
              <button data-bg="off" class="btn-toggle w-14 px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">Off</button>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2">
            <span class="text-xs text-slate-600 dark:text-slate-300">Reading width</span>
            <div class="inline-flex overflow-hidden rounded-md border border-black/10 dark:border-white/10">
              <button data-w="65" class="btn-toggle w-14 px-2 py-1 text-xs hover:bg-black/5 dark:hover:bg-white/10" type="button">Narrow</button>
              <button data-w="75" class="btn-toggle w-14 px-2 py-1 text-xs hover:bg-black/5 dark:hover:bg-white/10" type="button">Normal</button>
              <button data-w="85" class="btn-toggle w-14 px-2 py-1 text-xs hover:bg-black/5 dark:hover:bg-white/10" type="button">Wide</button>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2 mt-2">
            <span class="text-xs text-slate-600 dark:text-slate-300">Auto-hide header</span>
            <div class="inline-flex overflow-hidden rounded-md border border-black/10 dark:border-white/10">
              <button data-ah="on" class="btn-toggle w-14 px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">On</button>
              <button data-ah="off" class="btn-toggle w-14 px-2 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/10" type="button">Off</button>
            </div>
          </div>
          <div class="mt-3 text-right">
            <button id="readerReset" class="text-xs text-slate-600 dark:text-slate-300 hover:underline px-2 py-1" type="button">Reset to defaults</button>
          </div>`;
        const rightBox = document.querySelector('header .flex.items-center.gap-2:last-child');
        if (rightBox) { rightBox.classList.add('relative'); rightBox.appendChild(wrap); }
        const syncActive = () => {
          const ffV = localStorage.getItem('reader:ff') || 'serif';
          wrap.querySelectorAll('button[data-ff]')?.forEach(b=> b.setAttribute('aria-pressed', b.getAttribute('data-ff')===ffV ? 'true':'false'));
          const wV = localStorage.getItem('reader:width') || '75';
          wrap.querySelectorAll('button[data-w]')?.forEach(b=> b.setAttribute('aria-pressed', b.getAttribute('data-w')===wV ? 'true':'false'));
          const bgV = localStorage.getItem('reader:bg') || 'on';
          wrap.querySelectorAll('button[data-bg]')?.forEach(b=> b.setAttribute('aria-pressed', b.getAttribute('data-bg')===bgV ? 'true':'false'));
          const ahV = localStorage.getItem('reader:autohide') || 'off';
          wrap.querySelectorAll('button[data-ah]')?.forEach(b=> b.setAttribute('aria-pressed', b.getAttribute('data-ah')===ahV ? 'true':'false'));
        };
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'readerControlsToggle';
        toggleBtn.type = 'button';
        toggleBtn.className = 'inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/10 hover:bg-black/5 dark:hover:bg-white/10 transition';
        toggleBtn.innerHTML = '<span class="font-semibold">Aa</span>';
        rightBox?.insertBefore(toggleBtn, rightBox.children[1]);
        toggleBtn.addEventListener('click', ()=>{
          wrap.classList.toggle('hidden');
        });
        document.addEventListener('click', (e)=>{
          if (!wrap.contains(e.target) && e.target !== toggleBtn && !toggleBtn.contains(e.target)) {
            wrap.classList.add('hidden');
          }
        });
        const fontDec = wrap.querySelector('#fontDec');
        const fontInc = wrap.querySelector('#fontInc');
        fontDec?.addEventListener('click', ()=>{ const f = getNum(localStorage.getItem('reader:font')||'1',1); const nf = Math.max(0.85, Math.round((f-0.05)*100)/100); localStorage.setItem('reader:font', String(nf)); apply(); syncActive(); });
        fontInc?.addEventListener('click', ()=>{ const f = getNum(localStorage.getItem('reader:font')||'1',1); const nf = Math.min(1.4, Math.round((f+0.05)*100)/100); localStorage.setItem('reader:font', String(nf)); apply(); syncActive(); });
        wrap.querySelectorAll('button[data-w]')?.forEach(btn=>{ btn.addEventListener('click', ()=>{ localStorage.setItem('reader:width', btn.getAttribute('data-w')); apply(); syncActive(); }); });
        wrap.querySelectorAll('button[data-ff]')?.forEach(btn=>{ btn.addEventListener('click', ()=>{ localStorage.setItem('reader:ff', btn.getAttribute('data-ff')); apply(); syncActive(); }); });
        wrap.querySelectorAll('button[data-bg]')?.forEach(btn=>{ btn.addEventListener('click', ()=>{ localStorage.setItem('reader:bg', btn.getAttribute('data-bg')); apply(); syncActive(); }); });
        wrap.querySelectorAll('button[data-ah]')?.forEach(btn=>{ btn.addEventListener('click', ()=>{ localStorage.setItem('reader:autohide', btn.getAttribute('data-ah')); apply(); syncActive(); }); });
        wrap.querySelector('#readerReset')?.addEventListener('click', ()=>{ resetAll(); syncActive(); });
        syncActive();
      })();

      // Reveal animations
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!prefersReduced && 'IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          for (const e of entries) {
            if (e.isIntersecting) {
              e.target.classList.add('reveal-visible');
              io.unobserve(e.target);
            }
          }
        }, { threshold: 0.08 });
        document.querySelectorAll('.reveal').forEach(el => io.observe(el));
      } else {
        document.querySelectorAll('.reveal').forEach(el => el.classList.add('reveal-visible'));
      }
    </script>
  </body>
  </html>
